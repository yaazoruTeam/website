# 砖 1: 转 React
FROM node:20 AS builder
WORKDIR /app

# 注转拽转 拽爪 package.json 转拽转 转转 (爪 cache)
COPY lib/frontend/package*.json ./

# 转拽转 转转
RUN npm install

# 注转拽转 转拽转  专砖转 注专 TypeScript path mapping
COPY lib/model ./model

# 注转拽转 拽 拽专
COPY lib/frontend/. .

# 转 驻专拽
RUN npm run build

# 砖 2: Nginx 砖指转 转专
FROM nginx:alpine

# Copy the built React app
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy custom nginx configuration
COPY lib/frontend/nginx.conf /etc/nginx/conf.d/default.conf

# Create startup script with logging
RUN echo '#!/bin/sh' > /startup.sh && \
    echo 'echo "=================================="' >> /startup.sh && \
    echo 'echo " Frontend Server Starting..."' >> /startup.sh && \
    echo 'echo " Running on: http://localhost:80"' >> /startup.sh && \
    echo 'echo " Health check: http://localhost:80/health"' >> /startup.sh && \
    echo 'echo "=================================="' >> /startup.sh && \
    echo 'exec nginx -g "daemon off;"' >> /startup.sh && \
    chmod +x /startup.sh

EXPOSE 80

CMD ["/startup.sh"]