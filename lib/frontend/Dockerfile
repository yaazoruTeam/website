# 砖 1: 转 React
FROM node:20 AS builder
WORKDIR /app

# 注转拽转 拽爪 package.json 转拽转 转转 (爪 cache)
COPY lib/frontend/package*.json ./

# 转拽转 转转
RUN npm install

# 注转拽转 转拽转  专砖转 注专 TypeScript path mapping
COPY lib/model ./model

# 注转拽转 拽 拽专
COPY lib/frontend/. .

# 专转 砖转 住 
ARG VITE_BASE_URL=/api
ARG VITE_LIMIT=50
ARG VITE_FIREBASE_API_KEY
ARG VITE_FIREBASE_AUTH_DOMAIN
ARG VITE_FIREBASE_PROJECT_ID
ARG VITE_FIREBASE_STORAGE_BUCKET
ARG VITE_FIREBASE_MESSAGING_SENDER_ID
ARG VITE_FIREBASE_APP_ID
ARG VITE_FIREBASE_MEASUREMENT_ID

ENV VITE_BASE_URL=${VITE_BASE_URL}
ENV VITE_LIMIT=${VITE_LIMIT}
ENV VITE_FIREBASE_API_KEY=${VITE_FIREBASE_API_KEY}
ENV VITE_FIREBASE_AUTH_DOMAIN=${VITE_FIREBASE_AUTH_DOMAIN}
ENV VITE_FIREBASE_PROJECT_ID=${VITE_FIREBASE_PROJECT_ID}
ENV VITE_FIREBASE_STORAGE_BUCKET=${VITE_FIREBASE_STORAGE_BUCKET}
ENV VITE_FIREBASE_MESSAGING_SENDER_ID=${VITE_FIREBASE_MESSAGING_SENDER_ID}
ENV VITE_FIREBASE_APP_ID=${VITE_FIREBASE_APP_ID}
ENV VITE_FIREBASE_MEASUREMENT_ID=${VITE_FIREBASE_MEASUREMENT_ID}

# 转 驻专拽
RUN npm run build

# 砖 2: Nginx 砖指转 转专
FROM nginx:alpine

# Install OpenSSL for generating SSL certificates
RUN apk add --no-cache openssl

# Copy the built React app
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy custom nginx configuration (relative to build context root)
COPY lib/frontend/nginx.conf /etc/nginx/conf.d/default.conf

# Create SSL directory and generate self-signed certificate
RUN mkdir -p /etc/nginx/ssl && \
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /etc/nginx/ssl/server.key \
    -out /etc/nginx/ssl/server.crt \
    -subj "/C=IL/ST=Israel/L=TelAviv/O=Yaazoru/CN=localhost"

# Create startup script with logging
RUN echo '#!/bin/sh' > /startup.sh && \
    echo 'echo "=================================="' >> /startup.sh && \
    echo 'echo " Frontend Server Starting..."' >> /startup.sh && \
    echo 'echo " Running on: https://localhost:443"' >> /startup.sh && \
    echo 'echo " Health check: https://localhost:443/health"' >> /startup.sh && \
    echo 'echo "=================================="' >> /startup.sh && \
    echo 'exec nginx -g "daemon off;"' >> /startup.sh && \
    chmod +x /startup.sh

EXPOSE 80

CMD ["/startup.sh"]